# Architecture Monorepo Influence\n\nCe dépôt adopte une structure en **monorepo** articulée autour de workspaces npm, propulsé par [Turborepo](https://turbo.build/). Les applications finales (desktop Electron, serveur local, renderer web) vivent dans `apps/`, tandis que les briques réutilisables (SDK IPC, base de données, design system, configuration partagée) vivent dans `packages/`.\n\n`text\napps/\n  desktop/   # Processus principal + preload Electron durci\n  server/    # API Express/HTTP validée avec Zod\n  web/       # Renderer React/Vite strictement sandboxé\npackages/\n  config/    # ESLint, Prettier et tsconfig stricts partagés\n  db/        # Drizzle ORM + initialisation SQLite (WAL activé), migrations\n  sdk/       # Contrats TypeScript pour IPC, providers et réseaux, gestion d'erreurs\n  ui/        # Design system React réutilisable (premiers composants, Storybook)\ntests/       # Configurations de tests globales (Vitest, Playwright)\n.github/     # Workflows GitHub Actions pour CI/CD\n`\n\n## Principes clés\n\n1. **Sécurité Electron (P0) :**\n _ `contextIsolation: true`, `nodeIntegration: false`, `sandbox: true` pour le processus de rendu.\n _ **Content Security Policy (CSP) stricte :** Définie dans le processus principal d'Electron pour restreindre les ressources chargées par le renderer.\n _ **IPC (Inter-Process Communication) typé et validé par Zod :** Le script `preload` expose une API minimale et explicitement définie au renderer, avec validation d'entrée/sortie.\n _ **Stockage sécurisé des secrets :** Utilisation de [Keytar](https://github.com/atom/node-keytar) pour stocker les tokens et clés API sensibles de manière chiffrée au niveau du système d'exploitation, jamais dans le renderer.\n\n2. **Architecture des Providers Sociaux :**\n _ Le `packages/sdk` définit une interface `SocialMediaProvider` générique.\n _ `apps/server` utilise des implémentations de ces providers (ex: `AyrshareProvider`) pour interagir avec les APIs sociales.\n _ Cela permet de passer facilement d'un agrégateur (Ayrshare) à des intégrations natives à l'avenir.\n\n3. **Traitement vidéo local :**\n _ Utilisation de [FFmpeg](https://ffmpeg.org/) (via `fluent-ffmpeg` dans `apps/desktop`) pour l'extraction de métadonnées et le re-encodage/redimensionnement vidéo en local. Cela garantit la confidentialité et la performance.\n\n4. **Gestion des tâches asynchrone :**\n _ Les publications sont gérées comme des tâches asynchrones, stockées dans la base de données SQLite locale.\n _ Un scheduler (`node-cron` dans `apps/server`) surveille et exécute ces tâches (immédiatement ou à l'heure programmée).\n _ Un mécanisme de retries avec backoff exponentiel est intégré pour gérer les échecs temporaires des APIs externes.\n\n5. **Base de données locale (SQLite + Drizzle ORM) :**\n _ **Offline-first :** Permet à l'application de fonctionner sans connexion internet pour la plupart des opérations locales.\n _ **Migrations :** Gestion de l'évolution du schéma de la base de données pour une maintenabilité à long terme.\n _ **Seeders :** Scripts pour peupler la base de données avec des données de développement ou de démonstration.\n\n6. **Qualité et Observabilité :**\n _ **TypeScript strict :** Sur l'ensemble du monorepo pour la robustesse et la maintenabilité.\n _ **ESLint/Prettier/Commitlint/Husky :** Standardisation du code et des messages de commit.\n _ **Logging :** [Pino](https://getpino.io/) pour l'API serveur, [electron-log](https://github.com/megahertz/electron-log) pour le processus principal d'Electron et le preload.\n _ **Surveillance d'erreurs (opt-in) :** [Sentry](https://sentry.io/) pour capturer les erreurs en production dans le server et l'application desktop.\n \* **Tests complets :** Vitest (unitaires), Supertest (API), Playwright (E2E Electron) pour une couverture robuste.\n\n## Flux de Données (Simplifié)\n\n\`\`\`mermaid\ngraph TD\n A[Renderer (React/Vite)] -->|IPC (api.publishVideo)| B(Main Process Electron)\n B -->|Fetch/HTTP POST /api/posts/video| C(API Server Node/Express)\n C -->|Drizzle ORM| D(SQLite Database)\n D --> C\n C -->|Scheduler (node-cron)| E(Social Media Providers)\n E -->|Ayrshare API / Native APIs| F(Réseaux Sociaux Externes)\n F --> E\n E --> C --> D\n D --> C -->|HTTP GET /api/posts/:id/tasks| B\n B -->|IPC (polling)| A\n\n subgraph Traitement Vidéo (Desktop)\n A -->|IPC (api.getVideoMetadata)| B_VP(VideoProcessor)\n A -->|IPC (api.reencodeVideo)| B_VP\n B_VP -->|FFmpeg/FFprobe| B\n end\n\n subgraph Secrets (Desktop)\n A --X|NO direct access| G[Keytar (OS Keychain)]\n B -->|Keytar API| G\n end\n\`\`\`\n
